{% extends 'workflow/base.html' %}
{% block title %}Workflow {{ workflow.id }} Ä°zleme{% endblock %}

{% block content %}
  <style>
/* â€” Kart gÃ¶rÃ¼nÃ¼mleri â€” */
#step-cards .card {
  border: none;
  border-radius: 1rem;
  overflow: hidden;
  color: #333;
  box-shadow: 0 4px 16px rgba(0,0,0,0.05);
  transition: transform 0.3s, box-shadow 0.3s;
}
#step-cards .card-body h6.card-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.75rem;
  text-transform: capitalize;
}
#step-cards .col-md-4:nth-child(1) .card { background: linear-gradient(135deg, #F5F0FF 0%, #FFF0F5 100%); }
#step-cards .col-md-4:nth-child(2) .card { background: linear-gradient(135deg, #FFFAE6 0%, #FFECEC 100%); }
#step-cards .col-md-4:nth-child(3) .card { background: linear-gradient(135deg, #E8FFF9 0%, #E8F4FF 100%); }
#step-cards .card:hover { transform: translateY(-6px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
#step-cards .card-body p { font-size: 0.95rem; margin-bottom: 0.4rem; opacity: 0.9; }
#step-cards .card-body p strong { opacity: 1; }
#step-cards .card-body p span.badge { background: rgba(255,255,255,0.7); color: #333; font-size: 0.75rem; border-radius: 0.5rem; padding: 0.25em 0.6em; }

@media (max-width: 767px) { #step-cards .col-md-4 { flex: 0 0 100%; max-width: 100%; } }

/* â€” Kompozit modal iÃ§inde peek kartlarÄ± â€” */
.peek-card {
  border: 1px dashed rgba(0,0,0,0.12);
  border-radius: 12px;
  padding: 10px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.5));
}
.peek-title { font-weight: 700; margin-bottom: .35rem; }
.peek-kv { font-size: .92rem; margin: 0; }
.peek-kv code { font-size: .82rem; }
  </style>

  <!-- BaÅŸlÄ±k, Durum ve Butonlar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Workflow {{ workflow.id }}</h1>
    <div>
      <span id="wfStatus" class="badge bg-info py-2 px-3">{{ workflow.get_status_display }}</span>

      <!-- Eski: Zinciri Yeniden BaÅŸlat -->
      <form method="post" class="d-inline ms-2">
        {% csrf_token %}
        <input type="hidden" name="action" value="restart">
        <button type="submit" class="btn btn-sm btn-outline-primary">
          ðŸ”„ Zinciri Yeniden BaÅŸlat
        </button>
      </form>

      <!-- Yeni: Kompozit Zincir (dataset + train) -->
      <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#composeModal">
        ðŸ§© Zincir OluÅŸtur
      </button>
    </div>
  </div>

  <!-- AdÄ±m KartlarÄ± -->
  <div class="row mb-4" id="step-cards"></div>

  <!-- Epoch GrafiÄŸi -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-3">
          <canvas id="metricChart" class="w-100" style="height:350px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Epoch Tablosu + Genel Performans -->
  <div class="row mb-4">
    <div class="col-lg-8 col-sm-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Epoch Metrikleri</h5>
        </div>
        <div class="card-body p-3 table-responsive">
          <table class="table table-striped table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Epoch</th>
                <th>EÄŸitim Acc</th>
                <th>DoÄŸrulama Acc</th>
              </tr>
            </thead>
            <tbody id="metrics-body">
              <tr><td colspan="3" class="text-center py-3">YÃ¼kleniyorâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-sm-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Genel Performans</h5>
        </div>
        <div class="card-body d-flex flex-column align-items-start p-3" id="summary-body">
          <p class="text-muted">YÃ¼kleniyorâ€¦</p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // DOM referanslarÄ±
    const statusSpan    = document.getElementById('wfStatus');
    const stepsContainer= document.getElementById('step-cards');
    const metricsBody   = document.getElementById('metrics-body');
    const summaryBody   = document.getElementById('summary-body');
    const ctx           = document.getElementById('metricChart').getContext('2d');

    // Chart.js
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [
        { label: 'EÄŸitim Accuracy', data: [], pointRadius:4, tension:0.2 },
        { label: 'DoÄŸrulama Accuracy', data: [], pointRadius:4, tension:0.2 }
      ]},
      options: { scales:{ x:{title:{display:true,text:'Epoch'}}, y:{min:0,max:1} } }
    });

function fmtDT(iso){
  if(!iso) return 'â€”';
  try {
    return new Date(iso).toLocaleTimeString('tr-TR', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  } catch(_) {
    return iso;
  }
}


    function fetchSteps(){
      fetch("{% url 'workflow:steps' workflow.id %}")
        .then(r=>r.json())
        .then(steps=>{
          const c = document.getElementById('step-cards');
          c.innerHTML = '';
          steps.forEach(s=>{
            c.innerHTML += `
              <div class="col-md-4 mb-3">
                <div class="card shadow-sm">
                  <div class="card-body">
                    <h6 class="card-title">${s.step_name}</h6>
                    <p><strong>Durum:</strong> ${s.step_status_display}</p>
                    <p><strong>Celery:</strong> ${s.celery_status || 'â€”'}</p>

                    <p><strong>BaÅŸla:</strong> ${fmtDT(s.started_at)}</p>
                    <p><strong>BitiÅŸ:</strong> ${fmtDT(s.completed_at)}</p>

                  </div>
                </div>
              </div>`;
          });
        });
    }

    function fetchMetrics(){
      fetch("{% url 'workflow:metrics' workflow.id %}")
        .then(r=>r.json())
        .then(data => {
          chart.data.labels = data.map(e=>e.epoch);
          chart.data.datasets[0].data = data.map(e=>e.train_acc);
          chart.data.datasets[1].data = data.map(e=>e.val_acc);
          chart.update();

          if(data.length){
            metricsBody.innerHTML = '';
            data.forEach(m => {
              metricsBody.innerHTML += `
                <tr>
                  <td>${m.epoch}</td>
                  <td>${m.train_acc.toFixed(2)}</td>
                  <td>${m.val_acc.toFixed(2)}</td>
                </tr>`;
            });
          } else {
            metricsBody.innerHTML = `<tr><td colspan="3" class="text-center py-3">HenÃ¼z metrik yok.</td></tr>`;
          }
        });
    }

    function fetchSummary(){
      fetch("{% url 'workflow:result' workflow.id %}")
        .then(r => {
          if(r.status === 200) return r.json();
          throw new Error('No result');
        })
        .then(d => {
          summaryBody.innerHTML = `
            <p class="mb-2"><strong>Train Acc:</strong> ${d.train_acc.toFixed(2)}</p>
            <p class="mb-2"><strong>Val Acc:</strong>   ${d.val_acc.toFixed(2)}</p>
            <a href="${d.model_url}" class="btn btn-success mt-3">
              ðŸ“¥ <span class="ms-1">Modeli Ä°ndir</span>
            </a>`;
        })
        .catch(_=>{
          summaryBody.innerHTML = `<p class="text-muted">Model henÃ¼z tamamlanmadÄ±.</p>`;
        });
    }

    // ---- Zincir bitene kadar poll et ----
    let pollTimer = null;
    const DONE_STATES = new Set(['COMPLETED','FAILED']);

    function startPolling(){
      if (pollTimer) return;
      pollTimer = setInterval(tick, 2000);
    }
    function stopPolling(){
      if (pollTimer){
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    function updateStatusBadge(j){
      statusSpan.textContent = j.status_display;
    }

    function tick(){
      fetch("{% url 'workflow:status' workflow.id %}")
        .then(r=>r.json())
        .then(j=>{
          updateStatusBadge(j);
          if (!DONE_STATES.has(j.status)) {
            fetchSteps(); fetchMetrics(); fetchSummary();
          } else {
            fetchSteps(); fetchMetrics(); fetchSummary(); stopPolling();
          }
        })
        .catch(_=>{});
    }

    // BaÅŸlangÄ±Ã§
    tick();
    startPolling();
  </script>

  <!-- ðŸ§© Kompozit Zincir Modal (sade: dataset + train) -->
  <div class="modal fade" id="composeModal" tabindex="-1" aria-labelledby="composeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="post" class="modal-content" id="composeForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="compose">
        <div class="modal-header">
          <h5 class="modal-title" id="composeLabel">Kompozit Zincir OluÅŸtur</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- DATASET WF -->
            <div class="col-md-6">
              <label class="form-label">Upload Dataset KaynaÄŸÄ± (WF ID)</label>
              <input type="text" inputmode="numeric" pattern="[0-9]*" name="dataset_wf" id="in_dataset" class="form-control"
                     placeholder="BoÅŸsa: mevcut WF (#{{ workflow.id }})">
              <div class="form-text">SeÃ§ilen WFâ€™in <strong>dataset</strong>â€™i alÄ±nÄ±r.</div>
              <div class="peek-card mt-2" id="peek_dataset" hidden>
                <div class="peek-title">Dataset</div>
                <p class="peek-kv" id="pd_name">â€”</p>
                <p class="peek-kv"><small>Path:</small> <code id="pd_path">â€”</code></p>
              </div>
            </div>

            <!-- TRAIN WF -->
            <div class="col-md-6">
              <label class="form-label">Train (KonfigÃ¼rasyon) KaynaÄŸÄ± (WF ID)</label>
              <input type="text" inputmode="numeric" pattern="[0-9]*" name="train_wf" id="in_train" class="form-control"
                     placeholder="BoÅŸsa: mevcut WFâ€™in configâ€™i">
              <div class="form-text">SeÃ§ilen WFâ€™in <strong>config</strong>â€™i (model & hiperparametreler).</div>
              <div class="peek-card mt-2" id="peek_train" hidden>
                <div class="peek-title">Config</div>
                <pre class="mb-0 small" id="pt_json">{}</pre>
              </div>
            </div>
          </div>

          <div class="alert alert-info mt-3 mb-0 small">
            <strong>Ã‡alÄ±ÅŸma ÅŸekli:</strong> Dataset ve config seÃ§ilir; ardÄ±ndan <strong>Upload â†’ Preprocess â†’ Train</strong>
            adÄ±mlarÄ± <u>baÅŸtan</u> Ã§alÄ±ÅŸÄ±r ve sonuÃ§ yeni bir Workflow olarak kaydedilir.
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">VazgeÃ§</button>
          <button type="submit" class="btn btn-primary">BaÅŸlat</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // YalnÄ±zca rakam kabul et (yazma/paste)
    document.querySelectorAll('#composeForm input[pattern="[0-9]*"]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const v = e.target.value.replace(/\D+/g,'');
        if (e.target.value !== v) e.target.value = v;
      });
    });

    // Peek helper (WorkflowPeekAPIView)
    const peekUrlTpl = "{% url 'workflow:peek' 0 %}".replace(/0\/$/, 'ID/'); // .../peek/ID/
    function peekWorkflow(id){
      if(!id) return Promise.resolve(null);
      const url = peekUrlTpl.replace('ID/', String(id).trim() + '/');
      return fetch(url).then(r => r.ok ? r.json() : null).catch(_=>null);
    }
    function show(el, yes){ el.hidden = !yes; }

    // Dataset peek
    const inDataset = document.getElementById('in_dataset');
    const pkDataset = document.getElementById('peek_dataset');
    const pd_name = document.getElementById('pd_name');
    const pd_path = document.getElementById('pd_path');

    inDataset.addEventListener('input', async ()=>{
      const data = await peekWorkflow(inDataset.value);
      if(data){
        pd_name.textContent = `#${data.id} â€” ${data.dataset?.name ?? 'â€”'}`;
        pd_path.textContent = data.dataset?.file_path ?? 'â€”';
        show(pkDataset, true);
      }else{
        show(pkDataset, false);
      }
    });

    // Train (config) peek
    const inTrain = document.getElementById('in_train');
    const pkTrain = document.getElementById('peek_train');
    const pt_json = document.getElementById('pt_json');

    inTrain.addEventListener('input', async ()=>{
      const data = await peekWorkflow(inTrain.value);
      if(data){
        pt_json.textContent = JSON.stringify(data.config || {}, null, 2);
        show(pkTrain, true);
      }else{
        show(pkTrain, false);
      }
    });
  </script>
{% endblock %}
